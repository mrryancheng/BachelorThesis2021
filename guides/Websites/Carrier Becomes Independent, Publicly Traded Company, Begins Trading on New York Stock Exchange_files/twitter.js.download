define(['jquery'],function($){function escapeHTML(str){str=str.replace(new RegExp("&","g"),"&amp;");str=str.replace(new RegExp("<","g"),"&lt;");str=str.replace(new RegExp(">","g"),"&gt;");str=str.replace(new RegExp("\"","g"),"&quot;");return str;}
var releaseTweet=$('.social-links .btn-twitter');var assetTweet=$('.lightbox-item');var logoTweet=$('.release-header .logo');var pullQuoteTweet=$('.pull-quote .btn-twitter');var mobileShare=$('.social-share-mobile');var mobileReleaseTweet=$('.btn-twitter__mobile');var bitlyDomain='prn.to';$(mobileShare).on('show.bs.modal',function(){initTwitter($(mobileReleaseTweet));});$('.gallery').on('onAfterSlide.lg ',function(e,p,i){$('#lg-share').unbind('click.twitter').one('click.twitter',function(){initTwitter($(assetTweet[i]));});});$('.release-header').on('onAfterSlide.lg ',function(e,p,i){$('#lg-share').unbind('click.twitter').one('click.twitter',function(){initTwitter($(logoTweet[i]));});});if(releaseTweet.length>0){$.each(releaseTweet,function(i,v){$(v).on('click',function(){initTwitter($(releaseTweet[0]));});});}
if(pullQuoteTweet.length>0){$.each(pullQuoteTweet,function(i,v){$(v).on('click',function(){initTwitter($(pullQuoteTweet[0]));});});}
function initTwitter(self){var url=self.data('twitter-share-url')||self.children('.img-responsive').attr('src');var t=self.data('tweet-text'),urlClean=((url.indexOf('?'))>-1&&(url.indexOf('?v=')==-1)?url.substring(0,url.indexOf('?')):url),urlShort='',domain=bitlyDomain,templateUrl=escapeHTML(window.location.origin)+'/bin/prn/bitly/api/twitter.txt',req={longURL:urlClean,domain:domain};$.post(templateUrl,req,function(res){urlShort=res;}).done(function(){var max=140-(urlShort.length+1);var position='';if(t.length>max){t=t.substr(0,(max-3))+'...';}
if(t.indexOf("&#39;")>-1){t=t.replace(new RegExp("&#39;","g"),"'");}
if(t.indexOf("&#34;")>-1){t=t.replace(new RegExp("&#34;","g"),'"');}
if(t.indexOf("&#34;")>-1){t=t.replace(new RegExp("&#34;","g"),'"');}
if(self.hasClass('lightbox-item')||self.hasClass('logo')){$('#lg-share-twitter').attr('href','https://twitter.com/intent/tweet?text='+encodeURIComponent(t)+'&url='+urlShort);}else if(self.hasClass('btn-twitter')){console.log('getting this far?');var popupURL='http://twitter.com/intent/tweet?text='+encodeURIComponent(t+' '+urlShort);window.open(popupURL,"Twitter","width=550, height=420, location=1, status=1",'_blank');}else if(self.hasClass('btn-twitter__mobile')){mobileReleaseTweet.on('click',function(){var popupURL='http://twitter.com/intent/tweet?text='+encodeURIComponent(t+' '+urlShort);window.open(popupURL,"Twitter","width=550, height=420, location=1, status=1",'_blank');});}});}});